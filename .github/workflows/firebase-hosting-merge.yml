# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase Hosting on merge
on:
  push:
    branches:
      - develop
  # Allow manual trigger for iOS builds
  workflow_dispatch:
    inputs:
      build_ios:
        description: 'Build and upload iOS to TestFlight'
        required: false
        type: boolean
        default: false
      ios_changelog:
        description: 'iOS release notes for TestFlight'
        required: false
        default: 'Bug fixes and performance improvements'
      ios_scheme:
        description: 'Xcode scheme (default: Runner)'
        required: false
        default: 'Runner'

permissions:
  contents: write

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      # Checkout the repository
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Set up Flutter (reads from .flutter-version)
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version-file: .flutter-version
          cache: true

      # Set up Python for upload script
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # Install Python dependencies
      - name: Install Python Dependencies
        run: pip install -r scripts/requirements.txt

      # Run Flutter pub get to install dependencies
      # Note: Pub cache is handled by flutter-action with pub-cache-key
      - name: Install Dependencies
        run: |
          flutter --version
          flutter pub get -v

      # Run tests (fail fast before building)
      - name: Run Tests
        run: flutter test

      # Run Python script tests
      - name: Run Python Script Tests
        run: |
          cd scripts
          python -m unittest discover -s test -p "test_*.py" -v
        continue-on-error: false

      # Cache Gradle dependencies for faster Android builds
      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            android/.gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # Build Flutter Android APK
      - name: Build Flutter Android APK
        run: flutter build apk --release

      # Prepare versioned APK files
      - name: Prepare Versioned APK Files
        id: prepare_apk
        run: |
          python scripts/prepare_apk.py \
            build/app/outputs/flutter-apk/app-release.apk \
            --github-output

      # Publish versioned APK to GitHub Releases
      - name: Publish Versioned APK to GitHub Releases
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python scripts/upload_to_github_releases.py \
            "${{ steps.prepare_apk.outputs.versioned_path }}" \
            --asset-name "${{ steps.prepare_apk.outputs.versioned_name }}" \
            --github-output

      # Publish stable-name APK to GitHub Releases (stable URL)
      - name: Publish Stable APK to GitHub Releases
        id: upload_apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python scripts/upload_to_github_releases.py \
            "${{ steps.prepare_apk.outputs.stable_path }}" \
            --asset-name "${{ steps.prepare_apk.outputs.stable_name }}" \
            --github-output

      # Build Flutter Web with stable APK download link
      - name: Build Flutter Web
        env:
          FIREBASE_EMAIL: ${{ secrets.FIREBASE_EMAIL || vars.FIREBASE_EMAIL }}
          FIREBASE_PASSWORD: ${{ secrets.FIREBASE_PASSWORD || vars.FIREBASE_PASSWORD }}
          APK_DOWNLOAD_URL: ${{ steps.upload_apk.outputs.stable_url }}
        run: |
          echo "APK Download URL (Stable): $APK_DOWNLOAD_URL"
          if [ -z "$APK_DOWNLOAD_URL" ]; then
            echo "ERROR: APK_DOWNLOAD_URL is empty!"
            exit 1
          fi
          flutter build web \
            --dart-define=FIREBASE_EMAIL=$FIREBASE_EMAIL \
            --dart-define=FIREBASE_PASSWORD=$FIREBASE_PASSWORD \
            --dart-define=APK_DOWNLOAD_URL=$APK_DOWNLOAD_URL

      # (Optional) Upload the build artifacts for later use (e.g., deployment)
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: flutter-web-build
          path: build/web  # Path where Flutter outputs the web build

      # Deploy pre-built web app to Firebase Hosting
      - uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          channelId: live
          projectId: serhii-hrabas
          target: serhii-hrabas
          entryPoint: ./

  # iOS TestFlight deployment (manual trigger only)
  ios_testflight:
    name: Build and Upload iOS to TestFlight
    runs-on: macos-latest
    # Only run if manually triggered with build_ios=true
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.build_ios == 'true'
    timeout-minutes: 60
    needs: build_and_deploy  # Wait for web deployment to complete

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.4'
          channel: 'stable'
          cache: true

      - name: Verify Flutter installation
        run: |
          flutter --version
          flutter doctor -v

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Setup Python for iOS scripts
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Python dependencies
        run: pip install -r scripts/requirements.txt

      - name: Install CocoaPods dependencies
        working-directory: ios
        run: |
          pod install --repo-update
          pod --version

      - name: Create temporary keychain
        env:
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          python scripts/ios_keychain.py create \
            --password "${KEYCHAIN_PASSWORD:-}"

      - name: Import signing certificate
        env:
          IOS_DISTRIBUTION_CERT_BASE64: ${{ secrets.IOS_DISTRIBUTION_CERT_BASE64 }}
          IOS_DISTRIBUTION_CERT_PASSWORD: ${{ secrets.IOS_DISTRIBUTION_CERT_PASSWORD }}
        run: |
          python scripts/ios_certificate.py install \
            --cert-base64 "$IOS_DISTRIBUTION_CERT_BASE64" \
            --cert-password "$IOS_DISTRIBUTION_CERT_PASSWORD"

      - name: Install provisioning profile
        env:
          IOS_PROVISION_PROFILE_BASE64: ${{ secrets.IOS_PROVISION_PROFILE_BASE64 }}
        run: |
          python scripts/ios_provision.py install \
            --profile-base64 "$IOS_PROVISION_PROFILE_BASE64"

      - name: Validate iOS build environment
        run: |
          python scripts/ios_validate.py \
            --workspace ios/Runner.xcworkspace \
            --scheme "${{ github.event.inputs.ios_scheme || 'Runner' }}"

      - name: Build and upload to TestFlight
        env:
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_KEY_P8: ${{ secrets.APP_STORE_CONNECT_KEY_P8 }}
          IOS_WORKSPACE: ${{ github.workspace }}/ios/Runner.xcworkspace
          IOS_SCHEME: ${{ github.event.inputs.ios_scheme || 'Runner' }}
          CHANGELOG: ${{ github.event.inputs.ios_changelog || 'Bug fixes and performance improvements' }}
          PRODUCT_BUNDLE_IDENTIFIER: "com.insearching.portfolio"
          PROVISIONING_PROFILE_SPECIFIER: "Portfolio AppStore"
        run: |
          echo "ðŸ“¦ Building and uploading to TestFlight..."
          bundle exec fastlane ios beta

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-artifacts
          path: |
            build/*.ipa
            build/*.dSYM.zip
            fastlane/report.xml
          retention-days: 30
          if-no-files-found: ignore

      - name: Cleanup keychain
        if: always()
        run: |
          python scripts/ios_keychain.py cleanup || true

      - name: Cleanup temporary files
        if: always()
        run: |
          python scripts/ios_certificate.py cleanup || true
          python scripts/ios_provision.py cleanup || true

      - name: iOS Job Summary
        if: success()
        run: |
          echo "## âœ… iOS TestFlight Build Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The app has been successfully uploaded to TestFlight." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Info:**" >> $GITHUB_STEP_SUMMARY
          echo "- Scheme: ${{ github.event.inputs.ios_scheme || 'Runner' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Changelog: ${{ github.event.inputs.ios_changelog }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check [App Store Connect](https://appstoreconnect.apple.com/) for build status." >> $GITHUB_STEP_SUMMARY

      - name: iOS Job Summary on Failure
        if: failure()
        run: |
          echo "## âŒ iOS TestFlight Build Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for details." >> $GITHUB_STEP_SUMMARY